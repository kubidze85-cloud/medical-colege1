<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система тестирования - Медицинский колледж</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f8ff;
            color: #333;
            line-height: 1.6;
            font-size: 24px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, #1e5799, #207cca);
            color: white;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
        }
        
        .subtitle {
            font-size: 1.4rem;
            opacity: 0.9;
        }
        
        .login-container, .test-container, .result-container, .feedback-container, .admin-dashboard {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            font-size: 1.8rem;
        }
        
        input[type="text"], input[type="password"], input[type="file"] {
            width: 100%;
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 12px;
            font-size: 2rem;
            transition: border-color 0.3s;
            text-align: center;
        }
        
        input[type="text"]:focus, input[type="password"]:focus, input[type="file"]:focus {
            border-color: #207cca;
            outline: none;
        }
        
        button {
            background: linear-gradient(135deg, #1e5799, #207cca);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.8rem;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(30, 87, 153, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .question-container {
            text-align: center;
            padding: 30px;
        }
        
        .question-number {
            font-size: 1.8rem;
            color: #207cca;
            margin-bottom: 20px;
        }
        
        .question-text {
            font-size: 2.5rem;
            margin-bottom: 40px;
            line-height: 1.4;
            font-weight: bold;
        }
        
        .answers-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .answer-option {
            padding: 25px;
            background: #f8f9fa;
            border: 3px solid #e9ecef;
            border-radius: 12px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: bold;
        }
        
        .answer-option:hover {
            background: #e9f7fe;
            border-color: #207cca;
        }
        
        .answer-option.selected {
            background: #d1ecf1;
            border-color: #207cca;
            font-weight: bold;
        }
        
        .timer {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #e74c3c;
            margin: 30px 0;
            padding: 20px;
            background: #ffeaea;
            border-radius: 12px;
            border: 3px solid #ffcdd2;
        }
        
        .feedback {
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
            font-size: 2.2rem;
            text-align: center;
        }
        
        .correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .explanation {
            margin-top: 20px;
            font-size: 1.8rem;
            font-style: italic;
            font-weight: normal;
        }
        
        .progress-bar {
            height: 25px;
            background: #e9ecef;
            border-radius: 15px;
            margin: 30px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #207cca, #1e5799);
            border-radius: 15px;
            transition: width 0.3s;
        }
        
        .hidden {
            display: none;
        }
        
        .result-stats {
            text-align: center;
            font-size: 2rem;
            margin: 30px 0;
        }
        
        .admin-panel {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
        }
        
        .admin-panel h3 {
            color: #856404;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .admin-btn {
            background: #ffc107;
            color: #212529;
            padding: 15px;
            font-size: 1.4rem;
        }
        
        .admin-btn:hover {
            background: #e0a800;
        }
        
        .warning {
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            font-size: 1.8rem;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            font-size: 1.8rem;
        }
        
        .logo {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #6c757d;
            font-size: 1.2rem;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #28a745, #207cca);
            margin-bottom: 30px;
        }
        
        .admin-header h2 {
            color: white;
            padding: 20px;
        }
        
        .admin-section {
            margin: 30px 0;
        }
        
        .admin-section h3 {
            color: #1e5799;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e5799;
        }
        
        .stat-card .label {
            color: #6c757d;
            font-size: 1.2rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .close-modal {
            float: right;
            font-size: 2rem;
            cursor: pointer;
            color: #6c757d;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .admin-table th, .admin-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .admin-table th {
            background-color: #e9f7fe;
            color: #1e5799;
            font-weight: bold;
        }
        
        .admin-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-btn {
            padding: 8px 12px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-edit {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-view {
            background: #17a2b8;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-heartbeat"></i>
            </div>
            <h1>Медицинский колледж</h1>
            <p class="subtitle">Система тестирования знаний студентов</p>
        </header>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <h2>Вход в систему тестирования</h2>
            <div class="form-group">
                <label for="username">Фамилия:</label>
                <input type="text" id="username" placeholder="Введите вашу фамилию">
            </div>
            <div class="form-group">
                <label for="password">Пароль (4 цифры):</label>
                <input type="password" id="password" placeholder="Введите 4 цифры">
            </div>
            <button id="loginBtn">Войти</button>
            
            <!-- Admin Access -->
            <div class="admin-panel">
                <h3><i class="fas fa-crown"></i> Доступ для администратора</h3>
                <p>Для тестирования системы используйте:</p>
                <p><strong>Логин:</strong> admin</p>
                <button id="adminLoginBtn" class="admin-btn">Войти как администратор</button>
            </div>
            
            <div class="footer">
                <p>Работает без интернета в аудитории</p>
            </div>
        </div>
        
        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="admin-dashboard hidden">
            <div class="admin-header">
                <h2><i class="fas fa-user-shield"></i> Админ-панель системы</h2>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="number" id="totalGroups">15</div>
                    <div class="label">Групп</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalStudents">245</div>
                    <div class="label">Студентов</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalTeachers">18</div>
                    <div class="label">Преподавателей</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalTests">42</div>
                    <div class="label">Тестов</div>
                </div>
            </div>
            
            <div class="admin-section">
                <h3><i class="fas fa-cogs"></i> Управление системой</h3>
                <div class="admin-controls">
                    <button id="createGroupBtn"><i class="fas fa-users"></i> Создать группу</button>
                    <button id="addStudentBtn"><i class="fas fa-user-plus"></i> Добавить студента</button>
                    <button id="uploadTestBtn"><i class="fas fa-file-upload"></i> Загрузить тест</button>
                    <button id="viewResultsBtn"><i class="fas fa-chart-bar"></i> Просмотреть результаты</button>
                </div>
            </div>
            
            <div class="admin-section">
                <h3><i class="fas fa-network-wired"></i> Системные функции</h3>
                <div class="admin-controls">
                    <button id="syncDataBtn"><i class="fas fa-sync"></i> Синхронизировать данные</button>
                    <button id="manageUsersBtn"><i class="fas fa-users-cog"></i> Управление пользователями</button>
                    <button id="exportDataBtn"><i class="fas fa-file-export"></i> Экспорт данных</button>
                    <button id="logoutAdminBtn"><i class="fas fa-sign-out-alt"></i> Выйти из админ-панели</button>
                </div>
            </div>
            
            <!-- Upload Test Section -->
            <div class="admin-section">
                <h3><i class="fas fa-file-upload"></i> Загрузка тестов</h3>
                <div class="form-group">
                    <label for="testFileUpload">Выберите файл теста (TXT):</label>
                    <input type="file" id="testFileUpload" accept=".txt">
                </div>
                <button id="uploadTestFileBtn">Загрузить тест</button>
                <div id="uploadStatus" class="success hidden"></div>
            </div>
        </div>
        
        <!-- Test Screen -->
        <div id="testScreen" class="test-container hidden">
            <div class="progress-bar">
                <div id="progressBar" class="progress" style="width: 0%"></div>
            </div>
            <div class="timer" id="timer">Оставшееся время: 01:00</div>
            
            <div class="question-container">
                <div class="question-number" id="questionNumber">Вопрос 1 из 10</div>
                <div class="question-text" id="questionText">Текст вопроса будет здесь</div>
                
                <div class="answers-container" id="answersContainer">
                    <!-- Answer options will be inserted here -->
                </div>
            </div>
            
            <button id="nextBtn" class="hidden">Следующий вопрос</button>
        </div>
        
        <!-- Feedback Screen -->
        <div id="feedbackScreen" class="feedback-container hidden">
            <div id="feedbackMessage" class="feedback">
                <!-- Feedback message will be inserted here -->
            </div>
            <button id="continueBtn">Продолжить</button>
        </div>
        
        <!-- Results Screen -->
        <div id="resultsScreen" class="result-container hidden">
            <h2><i class="fas fa-clipboard-check"></i> Тест завершен</h2>
            <div class="result-stats">
                <p>Правильных ответов: <span id="correctAnswers">0</span> из <span id="totalQuestions">0</span></p>
                <p>Процент: <span id="percentage">0</span>%</p>
            </div>
            <div class="warning">
                <p><i class="fas fa-exclamation-triangle"></i> Результаты сохранены локально. Администратор должен вручную собрать данные.</p>
            </div>
            <button id="restartBtn"><i class="fas fa-redo"></i> Начать заново (только админ)</button>
        </div>
        
        <!-- Modal for Adding Student -->
        <div id="studentModal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h3><i class="fas fa-user-plus"></i> Добавить студента</h3>
                <div class="form-group">
                    <label for="modalStudentName">ФИО студента:</label>
                    <input type="text" id="modalStudentName" placeholder="Иванов Иван Иванович">
                </div>
                <div class="form-group">
                    <label for="modalStudentGroup">Группа:</label>
                    <select id="modalStudentGroup">
                        <option value="">Выберите группу</option>
                        <option value="1">СД-11</option>
                        <option value="2">ЛД-22</option>
                        <option value="3">П-33</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalStudentPassword">Пароль (4 цифры):</label>
                    <input type="password" id="modalStudentPassword" placeholder="1234">
                </div>
                <button id="saveStudentBtn">Сохранить студента</button>
            </div>
        </div>
        
        <!-- Modal for Creating Group -->
        <div id="groupModal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h3><i class="fas fa-users"></i> Создать группу</h3>
                <div class="form-group">
                    <label for="modalGroupName">Название группы:</label>
                    <input type="text" id="modalGroupName" placeholder="Например: СД-11">
                </div>
                <div class="form-group">
                    <label for="modalGroupSpecialty">Специальность:</label>
                    <select id="modalGroupSpecialty">
                        <option value="">Выберите специальность</option>
                        <option value="therapy">Лечебное дело</option>
                        <option value="pediatrics">Педиатрия</option>
                        <option value="nursing">Сестринское дело</option>
                        <option value="dentistry">Стоматология</option>
                    </select>
                </div>
                <button id="saveGroupBtn">Создать группу</button>
            </div>
        </div>
        
        <!-- Results Modal -->
        <div id="resultsModal" class="modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h3><i class="fas fa-chart-bar"></i> Результаты тестирования</h3>
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Студент</th>
                                <th>Предмет</th>
                                <th>Баллы</th>
                                <th>Оценка</th>
                                <th>Дата</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <tr>
                                <td>Абдырахманова Айгуль</td>
                                <td>Анатомия</td>
                                <td>42/50</td>
                                <td>5</td>
                                <td>20.06.2023</td>
                                <td>
                                    <button class="action-btn btn-view"><i class="fas fa-eye"></i></button>
                                    <button class="action-btn btn-edit"><i class="fas fa-edit"></i></button>
                                </td>
                            </tr>
                            <tr>
                                <td>Бекмаматов Бекзат</td>
                                <td>Физиология</td>
                                <td>38/45</td>
                                <td>4</td>
                                <td>20.06.2023</td>
                                <td>
                                    <button class="action-btn btn-view"><i class="fas fa-eye"></i></button>
                                    <button class="action-btn btn-edit"><i class="fas fa-edit"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample data storage (в реальной системе это будет база данных)
        let groups = [
            { id: 1, name: "СД-11", specialty: "Сестринское дело", students: 25 },
            { id: 2, name: "ЛД-22", specialty: "Лечебное дело", students: 30 },
            { id: 3, name: "П-33", specialty: "Педиатрия", students: 28 }
        ];
        
        let students = [
            { id: 101, name: "Абдырахманова Айгуль", group: 1, password: "2847" },
            { id: 102, name: "Бекмаматов Бекзат", group: 2, password: "5612" },
            { id: 103, name: "Васильева Мария", group: 3, password: "9374" }
        ];
        
        let testResults = [
            { id: 1, student: "Абдырахманова Айгуль", subject: "Анатомия", score: 42, total: 50, grade: 5, date: "20.06.2023" },
            { id: 2, student: "Бекмаматов Бекзат", subject: "Физиология", score: 38, total: 45, grade: 4, date: "20.06.2023" }
        ];
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const adminDashboard = document.getElementById('adminDashboard');
        const testScreen = document.getElementById('testScreen');
        const feedbackScreen = document.getElementById('feedbackScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const logoutAdminBtn = document.getElementById('logoutAdminBtn');
        
        const questionNumber = document.getElementById('questionNumber');
        const questionText = document.getElementById('questionText');
        const answersContainer = document.getElementById('answersContainer');
        const timerElement = document.getElementById('timer');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        
        const feedbackMessage = document.getElementById('feedbackMessage');
        const continueBtn = document.getElementById('continueBtn');
        
        const correctAnswersElement = document.getElementById('correctAnswers');
        const totalQuestionsElement = document.getElementById('totalQuestions');
        const percentageElement = document.getElementById('percentage');
        const restartBtn = document.getElementById('restartBtn');
        
        // Admin buttons
        const createGroupBtn = document.getElementById('createGroupBtn');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const uploadTestBtn = document.getElementById('uploadTestBtn');
        const viewResultsBtn = document.getElementById('viewResultsBtn');
        const syncDataBtn = document.getElementById('syncDataBtn');
        const manageUsersBtn = document.getElementById('manageUsersBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        
        // Test upload elements
        const testFileUpload = document.getElementById('testFileUpload');
        const uploadTestFileBtn = document.getElementById('uploadTestFileBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        
        // Modal elements
        const studentModal = document.getElementById('studentModal');
        const groupModal = document.getElementById('groupModal');
        const resultsModal = document.getElementById('resultsModal');
        const closeModals = document.querySelectorAll('.close-modal');
        const saveStudentBtn = document.getElementById('saveStudentBtn');
        const saveGroupBtn = document.getElementById('saveGroupBtn');
        const resultsTableBody = document.getElementById('resultsTableBody');
        
        // Modal inputs
        const modalStudentName = document.getElementById('modalStudentName');
        const modalStudentGroup = document.getElementById('modalStudentGroup');
        const modalStudentPassword = document.getElementById('modalStudentPassword');
        const modalGroupName = document.getElementById('modalGroupName');
        const modalGroupSpecialty = document.getElementById('modalGroupSpecialty');
        
        // App State
        let currentUser = null;
        let currentQuestion = 0;
        let score = 0;
        let timeLeft = 60;
        let timer = null;
        let shuffledQuestions = [];
        let userAnswers = [];
        let isAdmin = false;
        let currentRole = 'student'; // student, teacher, admin
        
        // Initialize
        function init() {
            // Load saved progress if exists
            loadProgress();
            
            // Event Listeners
            loginBtn.addEventListener('click', login);
            adminLoginBtn.addEventListener('click', adminLogin);
            logoutAdminBtn.addEventListener('click', logoutAdmin);
            nextBtn.addEventListener('click', nextQuestion);
            continueBtn.addEventListener('click', continueTest);
            restartBtn.addEventListener('click', restartTest);
            
            // Admin buttons - теперь настоящие функции
            createGroupBtn.addEventListener('click', openGroupModal);
            addStudentBtn.addEventListener('click', openStudentModal);
            uploadTestBtn.addEventListener('click', function() {
                alert('Функция загрузки теста работает!\nВ реальной системе здесь будет загрузка файлов тестов');
            });
            viewResultsBtn.addEventListener('click', openResultsModal);
            syncDataBtn.addEventListener('click', function() {
                alert('Синхронизация данных - функция администратора\nВ реальной системе здесь будет синхронизация с test1.html');
            });
            manageUsersBtn.addEventListener('click', function() {
                alert('Управление пользователями - функция администратора\nВ реальной системе здесь будет управление аккаунтами');
            });
            exportDataBtn.addEventListener('click', function() {
                alert('Экспорт данных - функция администратора\nВ реальной системе здесь будет экспорт в CSV');
            });
            
            // Test upload functionality
            uploadTestFileBtn.addEventListener('click', function() {
                if (testFileUpload.files.length === 0) {
                    alert('Пожалуйста, выберите файл теста');
                    return;
                }
                
                const file = testFileUpload.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        // Парсим TXT файл
                        const lines = content.split('\n').filter(line => line.trim() !== '');
                        const parsedQuestions = [];
                        
                        for (let i = 0; i < lines.length; i += 4) {
                            const question = lines[i]?.trim();
                            const wrongAnswer = lines[i+1]?.trim();
                            const correctAnswer = lines[i+2]?.trim();
                            
                            if (question && wrongAnswer && correctAnswer) {
                                parsedQuestions.push({
                                    question: question,
                                    answers: [wrongAnswer, correctAnswer],
                                    correct: 1 // Всегда второй вариант правильный в нашем формате
                                });
                            }
                        }
                        
                        uploadStatus.textContent = `Тест успешно загружен! Количество вопросов: ${parsedQuestions.length}`;
                        uploadStatus.classList.remove('hidden');
                        setTimeout(() => {
                            uploadStatus.classList.add('hidden');
                        }, 3000);
                    } catch (error) {
                        uploadStatus.textContent = 'Ошибка при чтении файла теста. Проверьте формат TXT.';
                        uploadStatus.classList.remove('hidden');
                        setTimeout(() => {
                            uploadStatus.classList.add('hidden');
                        }, 3000);
                    }
                };
                
                reader.onerror = function() {
                    uploadStatus.textContent = 'Ошибка чтения файла';
                    uploadStatus.classList.remove('hidden');
                    setTimeout(() => {
                        uploadStatus.classList.add('hidden');
                    }, 3000);
                };
                
                reader.readAsText(file);
            });
            
            // Modal events
            closeModals.forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    studentModal.style.display = 'none';
                    groupModal.style.display = 'none';
                    resultsModal.style.display = 'none';
                });
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === studentModal) {
                    studentModal.style.display = 'none';
                }
                if (event.target === groupModal) {
                    groupModal.style.display = 'none';
                }
                if (event.target === resultsModal) {
                    resultsModal.style.display = 'none';
                }
            });
            
            saveStudentBtn.addEventListener('click', saveStudent);
            saveGroupBtn.addEventListener('click', saveGroup);
            
            // Before unload warning
            window.addEventListener('beforeunload', function(e) {
                if (currentUser && currentQuestion < shuffledQuestions.length && !isAdmin) {
                    e.preventDefault();
                    e.returnValue = 'Тест не завершён. Прогресс будет сохранён, но нужно завершить позже.';
                    return e.returnValue;
                }
            });
        }
        
        // Login functions
        function login() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                alert('Пожалуйста, введите фамилию и пароль');
                return;
            }
            
            // Simple validation (in real app, this would be server-side)
            if (password.length !== 4 || !/^\d+$/.test(password)) {
                alert('Пароль должен состоять из 4 цифр');
                return;
            }
            
            currentUser = username;
            isAdmin = false;
            currentRole = 'student';
            startTest();
        }
        
        function adminLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            // Admin credentials
            if (username === 'admin' && password === 'admin') {
                currentUser = 'Администратор';
                isAdmin = true;
                currentRole = 'admin';
                showAdminDashboard();
            } else {
                alert('Неверные учетные данные администратора');
            }
        }
        
        function showAdminDashboard() {
            loginScreen.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
        }
        
        function logoutAdmin() {
            adminDashboard.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            currentUser = null;
            isAdmin = false;
            currentRole = 'student';
            document.title = "Система тестирования - Медицинский колледж";
        }
        
        // Modal functions
        function openStudentModal() {
            studentModal.style.display = 'flex';
            modalStudentName.value = '';
            modalStudentGroup.value = '';
            modalStudentPassword.value = '';
        }
        
        function openGroupModal() {
            groupModal.style.display = 'flex';
            modalGroupName.value = '';
            modalGroupSpecialty.value = '';
        }
        
        function openResultsModal() {
            // Обновляем таблицу результатов
            updateResultsTable();
            resultsModal.style.display = 'flex';
        }
        
        function updateResultsTable() {
            resultsTableBody.innerHTML = '';
            testResults.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.student}</td>
                    <td>${result.subject}</td>
                    <td>${result.score}/${result.total}</td>
                    <td>${result.grade}</td>
                    <td>${result.date}</td>
                    <td>
                        <button class="action-btn btn-view"><i class="fas fa-eye"></i></button>
                        <button class="action-btn btn-edit"><i class="fas fa-edit"></i></button>
                    </td>
                `;
                resultsTableBody.appendChild(row);
            });
        }
        
        function saveStudent() {
            const name = modalStudentName.value.trim();
            const group = modalStudentGroup.value;
            const password = modalStudentPassword.value.trim();
            
            if (!name || !group || !password) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            if (password.length !== 4 || !/^\d+$/.test(password)) {
                alert('Пароль должен состоять из 4 цифр');
                return;
            }
            
            // Create new student
            const newStudent = {
                id: students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 101,
                name: name,
                group: parseInt(group),
                password: password
            };
            
            students.push(newStudent);
            
            // Обновляем статистику
            const groupObj = groups.find(g => g.id === parseInt(group));
            if (groupObj) {
                groupObj.students += 1;
            }
            
            // Обновляем UI
            document.getElementById('totalStudents').textContent = students.length;
            
            alert(`Студент "${name}" успешно добавлен!`);
            studentModal.style.display = 'none';
        }
        
        function saveGroup() {
            const name = modalGroupName.value.trim();
            const specialty = modalGroupSpecialty.value;
            
            if (!name || !specialty) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            // Create new group
            const newGroup = {
                id: groups.length > 0 ? Math.max(...groups.map(g => g.id)) + 1 : 1,
                name: name,
                specialty: specialty,
                students: 0
            };
            
            groups.push(newGroup);
            
            // Обновляем статистику
            document.getElementById('totalGroups').textContent = groups.length;
            
            alert(`Группа "${name}" успешно создана!`);
            groupModal.style.display = 'none';
        }
        
        // Test functions
        function startTest() {
            // Shuffle questions
            shuffledQuestions = [...testData].sort(() => Math.random() - 0.5);
            
            // Show test screen
            if (isAdmin) {
                adminDashboard.classList.add('hidden');
            } else {
                loginScreen.classList.add('hidden');
            }
            testScreen.classList.remove('hidden');
            
            showQuestion();
            startTimer();
        }
        
        function showQuestion() {
            if (currentQuestion >= shuffledQuestions.length) {
                showResults();
                return;
            }
            
            const question = shuffledQuestions[currentQuestion];
            
            // Update UI
            questionNumber.textContent = `Вопрос ${currentQuestion + 1} из ${shuffledQuestions.length}`;
            questionText.textContent = question.question;
            
            // Update progress bar
            const progress = ((currentQuestion) / shuffledQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
            
            // Clear previous answers
            answersContainer.innerHTML = '';
            
            // Add answer options
            question.answers.forEach((answer, index) => {
                const answerElement = document.createElement('div');
                answerElement.className = 'answer-option';
                answerElement.textContent = answer;
                answerElement.dataset.index = index;
                
                answerElement.addEventListener('click', () => selectAnswer(index, answerElement));
                
                answersContainer.appendChild(answerElement);
            });
            
            // Hide next button until answer is selected
            nextBtn.classList.add('hidden');
        }
        
        function selectAnswer(selectedIndex, element) {
            // Remove selection from other answers
            document.querySelectorAll('.answer-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Mark selected answer
            element.classList.add('selected');
            
            // Save user answer
            userAnswers[currentQuestion] = selectedIndex;
            
            // Show next button
            nextBtn.classList.remove('hidden');
        }
        
        function nextQuestion() {
            if (userAnswers[currentQuestion] === undefined) {
                alert('Пожалуйста, выберите ответ');
                return;
            }
            
            // Move to next question
            currentQuestion++;
            
            // Reset timer
            timeLeft = 60;
            
            // Show feedback
            showFeedback();
        }
        
        function showFeedback() {
            const question = shuffledQuestions[currentQuestion - 1];
            const userAnswer = userAnswers[currentQuestion - 1];
            const isCorrect = userAnswer === question.correct;
            
            // Update score
            if (isCorrect) {
                score++;
            }
            
            // Show feedback
            testScreen.classList.add('hidden');
            feedbackScreen.classList.remove('hidden');
            
            // Create feedback message
            feedbackMessage.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
            feedbackMessage.innerHTML = `
                <p>${isCorrect ? '✅ Правильно!' : '❌ Неправильно!'}</p>
                ${!isCorrect ? `<p>Правильный ответ: ${question.answers[question.correct]}</p>` : ''}
                <p class="explanation">${question.explanation}</p>
            `;
        }
        
        function continueTest() {
            feedbackScreen.classList.add('hidden');
            
            if (currentQuestion >= shuffledQuestions.length) {
                showResults();
            } else {
                testScreen.classList.remove('hidden');
                showQuestion();
                startTimer();
            }
        }
        
        function showResults() {
            testScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            // Update results
            correctAnswersElement.textContent = score;
            totalQuestionsElement.textContent = shuffledQuestions.length;
            const percentage = Math.round((score / shuffledQuestions.length) * 100);
            percentageElement.textContent = percentage;
            
            // Save final results to localStorage
            const resultData = {
                user: currentUser,
                role: currentRole,
                score: score,
                total: shuffledQuestions.length,
                percentage: percentage,
                date: new Date().toISOString(),
                answers: userAnswers.map((answer, index) => ({
                    question: shuffledQuestions[index].question,
                    userAnswer: shuffledQuestions[index].answers[answer],
                    correctAnswer: shuffledQuestions[index].answers[shuffledQuestions[index].correct],
                    isCorrect: answer === shuffledQuestions[index].correct
                }))
            };
            
            localStorage.setItem(`testResult_${currentUser}`, JSON.stringify(resultData));
            
            // Update document title
            document.title = "Тест завершен";
        }
        
        // Timer functions
        function startTimer() {
            clearInterval(timer);
            timeLeft = 60;
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    // Auto-select first answer if time runs out
                    if (userAnswers[currentQuestion] === undefined) {
                        const firstAnswer = document.querySelector('.answer-option');
                        if (firstAnswer) {
                            selectAnswer(0, firstAnswer);
                        }
                    }
                    setTimeout(() => {
                        nextQuestion();
                    }, 1000);
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `Оставшееся время: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running out
            if (timeLeft <= 10) {
                timerElement.style.color = '#e74c3c';
                timerElement.style.backgroundColor = '#ffeaea';
                timerElement.style.borderColor = '#ffcdd2';
            } else {
                timerElement.style.color = '#e74c3c';
                timerElement.style.backgroundColor = '#fff';
                timerElement.style.borderColor = '#ffcdd2';
            }
        }
        
        // Progress functions
        function saveProgress() {
            const progress = {
                currentQuestion: currentQuestion,
                score: score,
                userAnswers: userAnswers
            };
            
            localStorage.setItem(`testProgress_${currentUser}`, JSON.stringify(progress));
        }
        
        function loadProgress() {
            // In a real implementation, we would load progress here
            // For this demo, we'll just clear old progress on page load
        }
        
        // Admin functions
        function restartTest() {
            if (!isAdmin) {
                alert('Только администратор может перезапустить тест');
                return;
            }
            
            if (confirm('Вы уверены, что хотите перезапустить тест? Все данные будут удалены.')) {
                startTest();
            }
        }
        
        // Sample test data
        const testData = [
            {
                question: "Какой орган вырабатывает инсулин?",
                answers: [
                    "Печень",
                    "Поджелудочная железа",
                    "Щитовидная железа",
                    "Надпочечники"
                ],
                correct: 1,
                explanation: "Инсулин вырабатывается бета-клетками поджелудочной железы."
            },
            {
                question: "Сколько камер имеет сердце человека?",
                answers: [
                    "2",
                    "3",
                    "4",
                    "5"
                ],
                correct: 2,
                explanation: "Сердце человека имеет 4 камеры: два предсердия и два желудочка."
            },
            {
                question: "Какой витамин вырабатывается при воздействии солнечного света?",
                answers: [
                    "Витамин A",
                    "Витамин B",
                    "Витамин C",
                    "Витамин D"
                ],
                correct: 3,
                explanation: "Витамин D синтезируется в коже под действием ультрафиолетового излучения."
            },
            {
                question: "Какой артериальный давление считается нормальным для взрослого человека?",
                answers: [
                    "140/90 мм рт. ст.",
                    "120/80 мм рт. ст.",
                    "130/85 мм рт. ст.",
                    "110/70 мм рт. ст."
                ],
                correct: 1,
                explanation: "Нормальное артериальное давление - 120/80 мм рт. ст."
            },
            {
                question: "Какой орган является основным фильтром крови?",
                answers: [
                    "Сердце",
                    "Легкие",
                    "Почки",
                    "Печень"
                ],
                correct: 2,
                explanation: "Почки фильтруют кровь, удаляя продукты обмена и избыток воды."
            },
            {
                question: "Сколько пар ребер у человека?",
                answers: [
                    "10",
                    "11",
                    "12",
                    "13"
                ],
                correct: 2,
                explanation: "У человека 12 пар ребер, всего 24 ребра."
            },
            {
                question: "Какой гормон регулирует уровень кальция в крови?",
                answers: [
                    "Инсулин",
                    "Паратгормон",
                    "Адреналин",
                    "Тестостерон"
                ],
                correct: 1,
                explanation: "Паратгормон, вырабатываемый околощитовидными железами, регулирует уровень кальция."
            },
            {
                question: "Какой объем крови у взрослого человека?",
                answers: [
                    "3-4 литра",
                    "4-5 литров",
                    "5-6 литров",
                    "6-7 литров"
                ],
                correct: 1,
                explanation: "Объем крови у взрослого человека составляет 4-5 литров."
            },
            {
                question: "Какой нейромедиатор отвечает за передачу сигналов в нервно-мышечном синапсе?",
                answers: [
                    "Допамин",
                    "Серотонин",
                    "Ацетилхолин",
                    "Норадреналин"
                ],
                correct: 2,
                explanation: "Ацетилхолин - основной нейромедиатор в нервно-мышечном синапсе."
            },
            {
                question: "Сколько зубов у взрослого человека?",
                answers: [
                    "28",
                    "30",
                    "32",
                    "34"
                ],
                correct: 2,
                explanation: "У взрослого человека 32 зуба, включая 4 зуба мудрости."
            }
        ];
        
        // Initialize app
        init();
    </script>
</body>
</html>
